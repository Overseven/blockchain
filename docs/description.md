# Что творится-то!

## Содержание
- [Введение](#введение)
- [Участники сети](#участники-сети)
  - [Клиент](#клиент)
  - [Координатор](#координатор)
  - [Нода](#нода)
  - [Валидатор](#валидатор)
  - [Модератор](#модератор)
- [Экономика](#экономика)
  - [Генерация новых монет](#генерация-новых-монет)
  - [Транзакции](#транзакции)
  - [Майнинг](#майнинг)
- [Голосование](#голосование)
- [Синхронизация](#синхронизация)
- [Инструкции по запуску софта](#инструкции-по-запуску-софта)
  - [Запуск клиента](#запуск-клиента)
  - [Запуск валидатора](#запуск-валидатора)
  - [Запуск ноды](#запуск-ноды)

## Введение
EverlastTry - экспериментальный блокчейн для исследования возможностей распределенных технологий.

Основные характеристики:
- Алгоритм PoW([Proof-Of-Work](https://forklog.com/chto-takoe-proof-of-work-i-proof-of-stake/))
- Виды транзакций:
  - [трансфер](#трансфер) средств от одного кошелька к другому
  - [аирдроп](#аирдроп) - генерация монет от лица [модератора](#модератора) на указанный кошелек
  - заявка на [голосование](#голосование)
  - голос для [голосования](#голосование)

## Участники сети
Все участники сети блокчейна делятся на следующие классы:
- [Клиент](#клиент)
- [Координатор](#координатор)
- [Нода](#нода)
- [Валидатор](#валидатор)
- [Модератор](#модератор)

### Клиент
Клиент - легковесная программа, позволяющая совершать транзакции со своего кошелька, отображать свой баланс и некоторую статистику сети в целом.


Клиент при запуске получает от [координатора](#координатор) актуальный список адресов действующих нод.
При отправке транзакции запрос на её обработку передаётся всем известным нодам.

Клиент в запросе указывает размер комиссии, которую он готов заплатить за обработку транзакции.

Для того, чтобы понять, проведена ли успешно транзакция, клиент подписывается на оповещения от известных нод о любых транзакциях, связанных с их адресом. 
Если все или большая часть нод ответила одинаково, то транзакция считается проведенной.

### Координатор
Координатор - утилита, запущенная на сервере с публичным IP. Задача координатора - по запросу предоставлять IP адреса действующих нод.

Участники обращаются к координатору в случаях:
- Первый запуск, нет информации о нодах
- Недоступность известных нод

### Нода
Нода - программа, связующий элемент в сети, выполняет роль распространителя новых блоков, помогает синхронизировать блокчейны остальных участников.

При запуске нода регистрируется у [координатора](#координатор), получает адреса и подключается к остальным нодам.
Клиенты отправляют нодам запрос на добавление их транзакций в новый блок.

К ноде подключаются [валидаторы](#валидатор). Валидаторам передаётся список транзакций для обработки, в ответ, валидаторы формируют подписанные блоки.
Нода отправляет всем остальным известным нодам полученный блок.

Нода может изменить свои сетевые параметры через [транзакцию специального типа](#обновление-параметров-ноды), в которой должно быть указано распределение комиссии за подписываемые транзакции между самой нодой и валидатором.

### Валидатор
Валидатор (майнер) - это подписывающая блоки с транзакциями программа. Валидатор подключается к нодам, получает от них данные, требующие обработки.
Если валидатор доверяет ноде к которой подключен, то он может не хранить локальную копию блокчейна, поручив ноде проверку на корректность поступающих запросов (см. [Запуск валидатора](#запуск-валидатора)).


Транзакции проверяются на наличие достаточных средств на счетах отправителей. Далее, валидатор объединяет их в группу (блок), и начинает подбор [Nonce](https://coincentral.com/what-is-a-nonce-proof-of-work/#:~:text=The%20nonce%20is%20a%20central,blockchains%20and%20cryptocurrencies%20like%20Bitcoin.&text=The%20nonce%20is%20a%20random,so%20win%20the%20block%20reward.).

При успешном поиске майнер отправляет всем нодам новый блок со своим встроенным публичным адресом для получения комиссии за валидацию.

Валидатор отслеживает появление на нодах новых блоков и корректирует процесс майнинга, если в текущем подписываемом блоке есть уже обработанные транзакции. 

### Модератор
Модератор - пользователь с общеисзвестным публичным адресом с повышенными правами. Модератор может проводить [аирдропы](#аирдроп), но не может хранить и передавать токены.
Модератор существует на стартовом этапе сети до момента необратимой [команды на отключение модератора](#отключение-модератора).

## Экономика
### Генерация новых монет
На первом этапе разработки эмиссия монет не ограничена и управляется [майнингом](#майнинг) новых блоков, [аирдропами](#аирдроп) и наградами за участие в [голосовании](#голосование).

### Транзакции
Виды транзакций в сети:
- [Трансфер](#трансфер)
- [Обновление параметров ноды](#обновление-параметров-ноды)
- [Аирдроп](#аирдроп)
- [Отключение модератора](#отключение-модератора)

#### Трансфер
Любой участник сети может инициировать перемещение своих средств на чужой кошелек.
Для этого необходимо сформировать запрос на обработку транзакции. 
В него входят:
- Адрес отправителя
- Адрес получателя
- Сумма отправляемых средств
- Комиссия
- Временная метка
- Адрес ноды
- [Подпись](https://ru.wikipedia.org/wiki/%D0%AD%D0%BB%D0%B5%D0%BA%D1%82%D1%80%D0%BE%D0%BD%D0%BD%D0%B0%D1%8F_%D0%BF%D0%BE%D0%B4%D0%BF%D0%B8%D1%81%D1%8C)

Для каждой ноды необходимо предоставить свою версию запроса, отличающуюся пунктом `Адрес ноды` (см. главу [майнинг](#майнинг)).

Чтобы была возможность получить первые токены на валидации, разрешено отправлять трансферы с нулевой суммой и комиссией, тогда ноды и валидаторы будут получать токены только от [эмиссии](#генерация-новых-монет).

#### Обновление параметров ноды
Для изменения параметров ноды ей необходимо провести пустую транзакцию, содержащую новые параметры:
- Коэффициент, отвечающий за то, какую часть от суммы всех комиссий при валидации заберет себе нода. Диапазон значений от `0.0` до `1.0`. Остальное получает валидатор.

#### Аирдроп
Аирдроп - подарочные токены для кошелька с указанным адресом.
Аирдроп может быть организован только [модератором](#модератор), владельцем кошелька с общеизвестным, вшитым в код публичным адресом.
На счету модератора не могут храниться монеты - все транзакции, связанные с этим адресом, помимо аирдропа, игнорируются.

#### Отключение модератора
Это особая транзакция, которая лишает модератора всех прав, и говорит всем участникам сети о том, что с этого момента необходимо игнорировать все сообщения поступающие с адресов модератора. Автором транзакции должен быть сам модератор.
Может быть применена лишь один раз, результат не обратим.

### Майнинг
Ноды и валидаторы за поддержание работы сети получают награду, состоящую из двух частей:
- комиссия, которую платят [клиенты](#клиент)
- эмиссия токенов

[Клиенты](#клиент) отправляют [ноде](#нода) заявку на транзакцию, после чего нода проверяет валидность данных (наличие на счету отправителя указаной суммы, правильный адрес ноды, подпись). Если поля транзакции корректны, то нода передаёт её всем подключенным к ней [валидаторам](#валидатор).

#### Комиссия
После подписи нового блока комиссии из всех транзакций складываются и распределяются между нодой и [валидатором](#валидатор).

Базовое распределение комиссии:
- Нода - 20% от комиссии
- Валидатор - 80% от комиссии

Распределение награды можно регулировать с помощью специальной [команды](#обновление-параметров-ноды).
Валидатор самостоятельно выбирает ноду, с которой будет работать. Выбор осуществляется с помощью поиска ноды с лучшим балансом между параметром распределения комиссии и пингом.

#### Эмиссия
Помимо комиссий от транзакций, при создании блока генерируются новые монеты. На начальной стадии разработки за каждый блок генерируется одинаковая сумма TRY, равная `кол-во транзакций в блоке * коэффициент эмиссии`.
Коэффициент может регулироваться путём [голосования](#голосование).

Новые монеты распределяются в равной пропорции между нодой и валидатором.

Все токены, полученные за валидацию, присваиваются нодой и валидатором в полном объёме, без каких-либо комиссий.

## Голосование
В сети поддерживаются голосования за изменения численных и качественных параметров всей сети.
Например, можно провести голосование за изменение размера эмиссии при валидации.

Регулируемые параметры:
- минимальная сумма для начала голосования
- ограничение по времени для набора минимальной суммы для голосования
- минимальный и максимальный порог для голосования
- продолжительность голосования
- способ учета голосов
- объём эмиссии монет при подписи блока

Заявку на голосование может отправить любой участник сети. При создании заявки создаётся уникальный идентификатор, являющийся альтернативой публичному адресу.
Для того чтобы начать голосование, необходимо заморозить (сделать транзакцию на идентификатор) минимально необходимое кол-во токенов. Остальные участники сети могут поддержать проведение голосования, отправляя свои токены на тот же адрес.

Если число замороженных токенов превышает пороговое значение, то через `10` блоков начинается голосование длительностью `30` блоков. Если минимальная сумма не успевает набраться за `10` блоков, то голосование не будет начато.
Вне зависимости от результата владельцам возвращаются токены с бонусом, немного превышающим оплаченную комиссию. Транзакции на идентификатор голосования, приходящие после окончания голосования - отбрасываются.

## Синхронизация
Для любой распределенной системы требуется синхронизация своих состояний, для этого используется решение, применяемое в алгоритме PoW([Proof-Of-Work](https://forklog.com/chto-takoe-proof-of-work-i-proof-of-stake/)). Ноды и валидаторы для получения награды распространяют новый блок по сети. Если блок является "устаревшим", неактуальным, то происходит запрос недостающих блоков с последующей заменой блоков из локальной копии блокчейна.

## Инструкции по запуску софта
### Запуск клиента
На первом этапе клиент - это консольная утилита, представляющая из себя отдельный .exe файл со следующими входными параметрами:
- Обязательные:
  - `pubKey <addres>` - публичный адрес
  - `privKey <key>` - приватный ключ
- Опциональные:
  - `nodeToConnect <ip:port>` - адрес уже существующей ноды для подключения через неё в сеть.
  - `saveLocalChain <bool>` - битовый флаг (0/1, false/true), отвечающий за сохранение локальной копии блокчейна. При значении false информация о текущем балансе берётся исключительно от запросов к нодам. Значение по умолчанию - `false`.
  - `coordinator <ip:port>` - адрес [координатора](#координатор).
  - `cfgFile <path>` - путь до файла конфигурации, в котором заданы параметры выше.

Примечание. Один из параметров `nodeToConnect` или `coordinator` должен быть представлен. Возможно использование обоих флагов, тогда данные о нодах будут складываться из обоих источников.

Пример:

``client.exe -pubKey AkZbjJQOk9G8o6GhS3+5v0JdMKq5qUkmQ2uL9pPtDX2I -privKey 1NSqxZbRHjpajCAlUfoYeV6sG+JVfp/CwZ2JjtIj+QQ= -saveLocalChain true -coordinator 127.0.0.1:64``

Перечисленные параметры можно хранить в конфигурационном файле и передавать программе путь до этого файла:

``client.exe -cfgFile myconfig.cfg``

Пример содержания конфигурационного файла:
```
pubKey:AkZbjJQOk9G8o6GhS3+5v0JdMKq5qUkmQ2uL9pPtDX2I
privkey:1NSqxZbRHjpajCAlUfoYeV6sG+JVfp/CwZ2JjtIj+QQ=
saveLocalChain:true
coordinator:127.0.0.1:64
```

__TODO: добавить инструкцию по отправке транзакции и проверке своего баланса.__

### Запуск валидатора
Софт валидатора - консольная утилита со следующими входными параметрами:
- Обязательные:
  - `pubKey <addres>` - публичный адрес
  - `privKey <key>` - приватный ключ
  - `nodeAddress <ip:port>` - адрес ноды для подключения
- Опциональные:
  - `saveLocalChain <bool>` - битовый флаг (0/1, false/true), отвечающий за сохранение локальной копии блокчейна. При значении `false` валидатор не проверяет получаемые от ноды транзакции на корректность. Значение по умолчанию - `false`.

После запуска в консоль будет выводиться информация о событиях в сети.

### Запуск ноды

Параметры для запуска ноды:
- Обязательные:
  - `pubKey <addres>` - публичный адрес
  - `privKey <key>` - приватный ключ
- Опциональные:
  - `nodeToConnect <ip:port>` - адрес уже существующей ноды для подключения через неё в сеть.
  - `coordinator <ip:port>` - адрес [координатора](#координатор).
  - `cfgFile <path>` - путь до файла конфигурации, в котором заданы параметры выше.

Примечание. Один из параметров `nodeToConnect` или `coordinator` должен быть представлен. Возможно использование обоих флагов, тогда данные о нодах будут складываться из обоих источников.
