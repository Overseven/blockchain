# Содержание:
- [Введение](#введение)
- [Участники сети](#участники-сети)
  - [Клиент](#клиент)
  - [Координатор](#координатор)
  - [Нода](#нода)
  - [Валидатор](#валидатор)
  - [Модератор](#модератор)
- [Структурные элементы](#структурные-элементы)
  - [Блокчейн](#блокчейн)
  - [Блок](#блок)
  - [Транзакция](#транзакция)
  - [БД](#БД)
  - [Снапшот](#снапшот)
 
 
# Введение
 
В этом файле содержатся размышления/планы по реализации описанному в [файле](https://github.com/Overseven/blockchain/blob/develop/docs/description.md) проекту.
 
# Участники сети
 
## Клиент
- создание транзакции (трансфер, голосование, ...)
- запрос списка активных нод у координатора
- уникальная подпись для каждой ноды
- отправка заявок нодам на обработку транзакции
- отслеживание проведения транзакции
- запрос у нод своего баланса

## Координатор
- приём заявок на регистрацию нод
- пинг ноды
- ответ на запрос об активных нодах

## Нода
- регистрация у координатора
- запрос списка нод у координатора
- подключение к нодам
- запрос у нод списка подключенных нод
- подключение к нодам (в итоге не более 20 нод, параметр должен быть настраиваемым в конфиг файле)
- приём заявок на регистрацию от майнеров
- приём заявки на обработку транзакции
- проверка транзакции на корректность (баланс, верно указан ли адрес ноды)
- накопление блока из транзакций
- отправка блока подключенным майнерам
- получение от майнеров подписанного блока

### Распространение блоков:
- отправка нового блока всем нодам
- если ноды приняли или имеют блок с таким же порядковым номером:
  - продолжаем майнить
  - обновляем баланс юзеров
- если у принимающиъ нод уже есть блоки с более высоким высоким порядковым номером:
  - запрашивается самая длинная цепочка (см. [Получение блоков](#получение-блоков))
  - берется подходящий снапшот, и пересчитывается баланс юзеров, голоса, и тд.

### Получение блоков:
__ID1__ - порядковый номер последнего блока из локальной копии блокчейна
__ID2__ - порядковый номер пришедшего блока
- если __ID1__ > __ID2__, то отправляем соответствующее сообщение
- если __ID1__ == __ID2__, то ничего не делаем
- если __ID1__ < __ID2__:
  - проверяем на корректность (???)
  - редактируем [списки транзакций](#списки-транзакций) 
  - если один или несколько блоков из локального блокчейна не совпадают с полученными:
    - пересчет баланса с ближайшего снапшота
  - в противном случае:
    - простое обновление баланса
  - обновление снапшотов, если это необходимо

### Списки транзакций
- очередь на подпись майнерами
- подписанные, отправленные, ожидающие подтверждения:
 - большинством нод принят блок, содержащий транзакцию
 - в блоках, пришедших от других нод содержится 

## Майнер
- варианты подключения к ноде:
  - запрос у координатора списка нод и подключение к случайной
  - подключение к заранее известной ноде
- выбор организации памяти:
  - хранить локальную копию блокчейна
  - не хранить
- сообщение о готовности к обработке транзакций
- приём от ноды блока:
  - если не храним локальную копию блокчейна:
    - майнинг
  - если храним:
    - [проверка на корректность](#транзакция)
    - майнинг


## Модератор
- скрипт, который создаёт файл с 5 парами ключей.
- генерация аирдропа
- задавание сложности майнинга
 
# Структурные элементы
 
## Блокчейн
- функция полного пересчета баланса всех участников сети с указанного блока
- 4 [снапшота](#снапшот)

## Блок
Проверка блока на корректность:
- все транзакции должны быть уникальными
- правильный номер блока и хэш предыдущего блока

## Транзакция
Проверка транзакции на корректность:
- правильная подпись
- на балансе отправителя достаточное кол-во средств
- временная метка отстаёт от локального времени не более чем на 5 минут, или спешит не более чем на 2 минуты
- этой транзакции нет в списке исполненных за последние 10 минут

## БД
Необходимо хранить:
- блоки
- [снапшоты](#снапшот) с хэшем последнего учитываемого блока
- баланс всех пользователей
- изменяемые параметры сети
- голосования

## Снапшот
- содержит:
  - баланс всех пользователей
  - параметры сети
  - информацию о голосованиях
  - хэш последнего учитываемого блока
- снапшоты отстают на 5, 10, 20, 40 блоков от последнего блока
- когда первый снапшот отстаёт от последнего блока на 10 блоков:
  - все снапшоты пересчитываются, сдвигаясь на 5 блоков в сторону конца блокчейна
